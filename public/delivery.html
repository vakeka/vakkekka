<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Puff&Go ‚Äî –î–æ—Å—Ç–∞–≤—â–∏–∫</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      background: #0e0e10;
      color: #fff;
      font-family: "Inter", sans-serif;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .info-box {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn {
      display: inline-block;
      background: #4c8bf5;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      margin: 10px;
      cursor: pointer;
      text-decoration: none;
      transition: 0.3s;
    }
    .btn:hover { background: #3a6fd9; }
    .btn-orange {
      background: #ff9800;
      color: #fff;
    }
    .btn-orange:hover {
      background: #e68900;
    }
    .btn-green {
      background: #4caf50;
      color: #fff;
    }
    .btn-green:hover { background: #43a047; }
  </style>
</head>
<body class="delivery">
  <header class="site-header">
    <div class="logo">Puff&Go</div>
    <nav class="nav">
      <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="liquids.html">–ñ–∏–¥–∫–æ—Å—Ç–∏</a>
      <a href="devices.html">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</a>
    </nav>
  </header>

  <main class="container">
    <h1>üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç–∞–≤—â–∏–∫–∞</h1>
    <div id="deliveryInfo" class="info-box"></div>

    <div style="margin-top:20px;text-align:center;">
      <button id="sendOrder" class="btn btn-green">üöö –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
      <button id="cancelOrder" class="btn" style="background:#f54c4c;">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
      <button id="goHome" class="btn" style="background:#4caf50;">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
      <button id="goProducts" class="btn btn-orange">üîÑ –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–≤–∞—Ä–∞–º</button>
    </div>
  </main>

  <script>
  const data = JSON.parse(localStorage.getItem("lastOrder"));
  const box = document.getElementById("deliveryInfo");

  if (data) {
    const items = Array.isArray(data.items) ? data.items : [{
      code: data.flavorCode || data.flavor || '',
      qty: Number(data.qty || 1),
      price: Number(data.price || 0)
    }];

    const totalPrice = items.reduce((sum, item) => sum + (Number(item.qty) * Number(item.price || data.price || 0)), 0);

    let msg = `üì¶ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑:<br><br>`;
    msg += `üìÖ –î–∞—Ç–∞: ${data.date}<br>`;
    msg += `‚è∞ –í—Ä–µ–º—è: ${data.time}<br>`;
    msg += `üì¶ –ö–æ–ª-–≤–æ –ø–æ –≤–∫—É—Å–∞–º:<br>`;
    items.forEach(item => {
      msg += `- ${item.code}: ${item.qty} —à—Ç.<br>`;
    });
    msg += `üí∞ –¶–µ–Ω–∞ –∑–∞ 1 —à—Ç: ${data.price}‚Ç¨<br>`;
    msg += `üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞: <strong>${totalPrice}‚Ç¨</strong><br>`;

    box.innerHTML = msg;

    document.getElementById("sendOrder").addEventListener("click", async () => {
      const order = JSON.parse(localStorage.getItem("lastOrder"));
      if (!order) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏!");

      try {
        order.BOT_TOKEN = "8481207050:AAFpfsL8b8MpewzokbZ8Ca1R3IPJtM1_dbc";
        order.DELIVERY_CHAT_ID = "-1003252162870";

        const res = await fetch("/.netlify/functions/sendOrder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(order)
        });

        const data = await res.json();
        if (data.ok) {
          alert("‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–æ—Å—Ç–∞–≤—â–∏–∫—É!");
          localStorage.removeItem("lastOrder");
          document.getElementById("deliveryInfo").innerHTML = "–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.";
        } else {
          alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞");
        }
      } catch (err) {
        console.error(err);
        alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
      }
    });

    document.getElementById("cancelOrder").addEventListener("click", () => {
      localStorage.removeItem("lastOrder");
      box.innerHTML = "–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—ë–Ω.";
      alert("–ó–∞–∫–∞–∑ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω—ë–Ω!");
    });

    document.getElementById("goProducts").addEventListener("click", () => {
      if (data.type === "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ") {
        window.location.href = "devices.html";
      } else if (data.type === "–ñ–∏–¥–∫–æ—Å—Ç—å") {
        window.location.href = "liquids.html";
      }
    });

  } else {
    box.innerHTML = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫–∞–∑–µ.";
  }

  const goHomeBtn = document.getElementById("goHome");
  goHomeBtn.addEventListener("click", () => {
    localStorage.removeItem("lastOrder");
    window.location.href = "index.html";
  });
</script>
</body>
<script src="script.js"></script>
</html>